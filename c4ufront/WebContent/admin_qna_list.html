<!DOCTYPE html>
<head>
    <meta charset="UTF-8">
    <title>admin_qna_list</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="./js/hyeongdon.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Raleway&display=swap');
        
        *{
            box-sizing:border-box;
            padding: 0;
            margin: 0;
            font-family:'Raleway', sans-serif;
            color : #222;
            line-height : 1.5em;
            font-weight:300;
        }

        .admin_qna_list .admin_qna_title{
            margin-left: 50px;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .admin_qna_list hr{
            opacity: 35%;
            width: 1050px;
            margin-left: 50px;
        }


        .admin_qna_list .qna_list{
            border: 1px solid;
            border-collapse: collapse;
            margin-left: 50px;
            margin-top: 20px;
        }

        .admin_qna_list .qna_list th,td{
            border: 1px solid;
        }

        .admin_qna_list .qna_list th{
            text-align: center;
            background-color: lightgrey;
            font-weight: 800;
        }

        .admin_qna_list .qna_list td{
            text-align: center;
        }

        .admin_qna_list td.qna_body_no{
            width: 80px;
        }

        .admin_qna_list td.qna_body_title{
            text-align: left;
            padding-left: 10px;
            padding-right: 10px;
            width: 700px;
        }

        .admin_qna_list td.qna_body_title:hover{
            font-weight: 800;
        }

        .admin_qna_list td.qna_body_name{
            width: 190px;
        }

        .admin_qna_list td.qna_body_delete{
            width: 70px;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .admin_qna_list td.qna_body_delete:hover{
            font-weight: 800;
        }

        .admin_qna_list span:hover{
            font-weight: 800;
            color: rgb(255, 87, 87);
        }

        .admin_qna_list div.page_group{
            margin-left: 40%;
            margin-top: 20px;
        }

        .admin_qna_list div.search{
            margin-left: 35%;
            margin-top: 10px;
        }

        .admin_qna_list input.btsearch{
            width: 40px;
            height: 24px;
            vertical-align: -1px;
        }
        
        .admin_qna_list input.inputsearch{
            width: 200px;
        }
        
    </style>
    <script>
        let frontContextPath = "http://localhost:8888/c4ufront";
        let backContextPath = "http://localhost:8888/c4uback";

        $(function () {
        	if(adminLoginStatus()==-9){
        		//어드민로그인실패
        		location.href=backContextPath+"/myLogin";
        		return;
        	}//if 어드민 로그인 확인
            $(".header").load("admin_header.html");
            
            function showList(responseObj){
                console.log(responseObj);
	            //테이블객체
	            var $tableObj =$("section>div.admin_qna_list>table.qna_list");

                $("section>div.admin_qna_list>table.qna_list tr.copy").remove();
                console.log("삭제 과정 거침");

                //원본행객체
                var $trOriginObj = $("section>div.admin_qna_list>table tr.origin");
                $trOriginObj.show(); //원본행객체 보여주기

                if(responseObj.status == -1){
                    alert(responseObj.msg);
                    return false;
                }else{
                    $(responseObj.pgb.list).each(function(index, element){
                        var $trCopyObj = $trOriginObj.clone(); //원본행객체의 복제본만들기
                        $trCopyObj.addClass("copy"); //복제본행의 클래스속성으로 copy설정
                        $trCopyObj.removeClass("origin"); //복제본행의 클래스속성중 origin제거

                        //복제본행의 내용 채우기 : 게시글번호
                        $trCopyObj.find("td.qna_body_no").html(element.qnaId);

                        //복제본행의 내용 채우기 : 게시글제목
                        $trCopyObj.find("td.qna_body_title").html(element.qnaTitle);

                         //복제본행의 내용 채우기 : 작성자
                         $trCopyObj.find("td.qna_body_name").html(element.student.studentName);

                        //복제본행의 내용 채우기 : 작성일자
                        $trCopyObj.find("td.qna_body_date").html(element.qnaDate);

                        //테이블객체의 자식객체로 복제본행을 추가
                        $tableObj.append($trCopyObj);
                    }); //each

                    $trOriginObj.hide();
                }
            };//function showList

            function pageGroup(responseObj){
                console.log(responseObj);

                var totalCnt_val = responseObj.pgb.totalCnt;
                var cnt_per_page_val = responseObj.pgb.cnt_per_page;
                var cnt_per_page_group_val = responseObj.pgb.cnt_per_page_group;
                var startPage_val = responseObj.pgb.startPage;
                var endPage_val = responseObj.pgb.endPage;
                var totalPage_val = responseObj.pgb.totalPage;
                var list_size_val = responseObj.pgb.list.length;

                console.log("totalCnt_val :"+totalCnt_val);
                console.log("cnt_per_page_val: "+cnt_per_page_val);
                console.log("cnt_per_page_group_val : "+cnt_per_page_group_val);
                console.log("startPage_val: "+startPage_val);
                console.log("endPage_val : "+ endPage_val);
                console.log("totalPage_val : "+ totalPage_val);
                console.log("list_size_val: "+ list_size_val);
                //divPageList객체
	            var $divPageListObj =$("section>div.admin_qna_list>div.page_list");

                $("section>div.admin_qna_list>div.page_list div.copy").remove();
                $("section>div.admin_qna_list>div.page_list span.copy").remove();

                //원본행객체
                var $pageGroupOriginObj = $("section>div.admin_qna_list>div.page_list>div.origin");
                $pageGroupOriginObj.show(); //원본행객체 보여주기

                if(responseObj.status == -1){
                    alert(responseObj.msg);
                    return false;
                }else{
                    var $pageGroupCopyObj = $pageGroupOriginObj.clone();  //원본행객체의 복제본만들기
                    $pageGroupCopyObj.addClass("copy"); //복제본행의 클래스속성으로 copy설정
                    $pageGroupCopyObj.removeClass("origin"); //복제본행의 클래스속성중 origin제거

                    var $prevArrowObj = $pageGroupCopyObj.find("span.page_btprev"); //복제행 객체의 이전 화살표 찾기
                    var $nextArrowObj = $pageGroupCopyObj.find("span.page_btnext"); //복제행 객체의 다음 화살표 찾기

                    //이전 화살표 show
                    if(startPage_val > cnt_per_page_group_val){
                        $prevArrowObj.show();
                    }
                    
                    //다음 화살표 show
                    if(endPage_val < totalPage_val){
                        $nextArrowObj.show();
                    }

                    //페이지 넘버 추가
                    for(var i = startPage_val; i<=endPage_val; i++){
                        var $pageNumberObj = $('<span class="page_number, copy">');
                        $pageNumberObj.html("&nbsp;"+"&nbsp;"+"&nbsp;"+i);
                        $nextArrowObj.before($pageNumberObj);
                        $pageNumberObj.show();
                        
                        if(totalCnt_val < cnt_per_page_val){
                            break;
                        }
                    }; //for

                    $divPageListObj.append($pageGroupCopyObj);
                } //else
                $pageGroupOriginObj.hide();

            };//function pageGroup

            $.ajax({
                "url": backContextPath+"/admin/qna/list",
                "method": "GET",
                "transformRequest": [
                null
                ],
                "transformResponse": [
                null
                ],
                "jsonpCallbackParam": "callback",
                "headers": {
                "Accept": "application/json, text/plain, */*"
                },
                "data": "",
                "timeout": {},
                success: function(responseObj){
                    showList(responseObj);
                    pageGroup(responseObj);
                }
            }); //$.ajax

            //--게시물 클릭 시작--
            $("section>div.admin_qna_list>table>tbody").on("click", "tr>td.qna_body_title", function(event){
                var qna_board_no = $(event.target).prev().html();
                console.log(qna_board_no);
                $("section").load("admin_qna_detail.html", function(){
                    $.ajax({
                        "url": backContextPath+"/admin/qna/detail/"+qna_board_no,
                        "method": "get",
                        "transformRequest": [
                            null
                        ],
                        "transformResponse": [
                            null
                        ],
                        "jsonpCallbackParam": "callback",
                        "headers": {
                            "Accept": "application/json, text/plain, */*"
                        },
                        "timeout": {},
                        success:function(responseObj){
                            var qnaObj = responseObj.qna;
                            console.log(qnaObj);
                            if(responseObj.status == 1){
                                $("input.btqnacommentmodify").hide();
                                $("input.btqnacommentdelete").hide();

                                $("div.qna_detail_info>div.qna_detail_title>span.span_title").html(qnaObj.qnaTitle);
                                $("div.qna_detail_info>div.qna_detail_writer>span.span_writer").html(qnaObj.student.studentName);
                                $("div.qna_detail_info>div.qna_detail_date>span.span_date").html(qnaObj.qnaDate);
                                $("div.qna_detail_content>span.content").html(qnaObj.qnaContent);

                                if(qnaObj.qnaComment == null){
                                    $("div.qna_detail_comment").html("답변이 없습니다. 답변을 달아주세요!");
                                    $("input.btqnacommentmodify").show();
                                }else{
                                    $("div.qna_detail_comment").html(qnaObj.qnaComment);
                                    $("input.btqnacommentdelete").show();
                                }
                            }else{
                                alert(responseObj.msg);
                            }
                        },
                        error:function(jqXHR){
                            alert("에러:" + jqXHR.status);
                        }
                    }); //$.ajax
                });//load
                return false;
            });
            //--게시물 클릭 끝--

            //--검색버튼 클릭 시작--
            $("section>div.admin_qna_list>form input[type=button]").click(function(){
                $.ajax({
                        url: backContextPath+"/admin/qna/list/1/"+$("section>div.admin_qna_list>form input[name=word]").val(),
                        "method": "GET",
                        "transformRequest": [
                            null
                        ],
                        "transformResponse": [
                            null
                        ],
                        "jsonpCallbackParam": "callback",
                        "headers": {
                            "Accept": "application/json, text/plain, */*"
                        },
                        "data": "",
                        "timeout": {},
                        success: function(responseObj){
                            showList(responseObj);
                            pageGroup(responseObj);
                            console.log("검색 버튼이 요청함"+responseObj);
                            // if(responseObj.status = -1){ //Handler 해결 필요
                            //     alert("검색 결과가 없습니다.");
                            //     console.log("상태 확인");
                            // }
                        },
                        error: function(jqXHR){
                            // alert("jqXHR status :"+ jqXHR.status);
                            alert("검색 결과가 없습니다.");
                        }
                });
                return false;
            });
            //--검색버튼 클릭 끝--

            //--페이징 숫자 버튼 클릭 시작--
            $("body>section>div>div.page_list").on("click","span",function(event){
                // console.log($(event.target).html());
                var str_page_number = null;
                if($(event.target).html() == $("span.page_btnext").html()){
                    var bt_next_arrow_val = $(event.target).prev().html();
                    // console.log("다음 화살표 값 자르기전: "+bt_next_arrow_val);
                    str_page_number = bt_next_arrow_val.split("&nbsp;&nbsp;&nbsp;");
                    str_page_number[1] = Number(str_page_number[1]) + 1;
                    // console.log("다음화살표"+str_page_number[1]);
                }else if($(event.target).html() == $("span.page_btprev").html()){
                    var bt_prev_arrow_val = $(event.target).next().html();
                    // console.log("이전 화살표 값 자르기전: "+bt_prev_arrow_val);
                    str_page_number = bt_prev_arrow_val.split("&nbsp;&nbsp;&nbsp;");
                    str_page_number[1] = Number(str_page_number[1]) - 1;
                    // console.log("이전화살표"+str_page_number[1]);
                }else{
                    var bt_page_number_val = $(event.target).html().trim();
                    str_page_number = bt_page_number_val.split("&nbsp;&nbsp;&nbsp;");
                    // console.log("숫자도 찍힘");
                }
                
                // console.log("현재 화살표 값"+str_page_number[1]);
                var word = $("section>div.admin_qna_list>form input[name=word]").val();
                var url = backContextPath+"/admin/qna/list/"+str_page_number[1];
                if(word.trim() != ''){
                    url += '/' + word;
                }
                
                $.ajax({
                        url: url,
                        "method": "GET",
                        "transformRequest": [
                            null
                        ],
                        "transformResponse": [
                            null
                        ],
                        "jsonpCallbackParam": "callback",
                        "headers": {
                            "Accept": "application/json, text/plain, */*"
                        },
                        "data": "",
                        "timeout": {},
                        success: function(responseObj){
                            showList(responseObj);
                            pageGroup(responseObj);
                        },
                        error: function(jqXHR){
                            // alert("jqXHR status :"+ jqXHR.status);
                            alert("검색 결과가 없습니다.");
                        }
                });//$.ajax
                return false;
            });
            //--페이징 숫자 버튼 클릭 끝--

        });
    </script>
</head>
<body>
    <header><div class="header"></div></header>
    <section>
        <div class="admin_qna_list">
            <div class="admin_qna_title">
                <h1>1:1 문의 관리</h1>
            </div>
            <hr>
            
            <table class="qna_list">
                <thead class="qna_head">
                    <tr class="qna_head_tr">
                        <th>번호</th>
                        <th>제목</th>
                        <th>작성자</th>
                        <th>날짜</th>
                    </tr>
                </thead>
                <tbody class="qna_body">
                    <tr class="qna_body_tr, origin" style="display:none">
                        <td class="qna_body_no">1114</td>
                        <td class="qna_body_title">강사님 연구원님 감사합니다~ </td>
                        <td class="qna_body_name">강사님연구원님짱</td>
                        <td class="qna_body_date">2021-05-07</td>
                    </tr>
                </tbody>
            </table>

            <div class="page_list">
                <div class="page_group, origin" style="display: none;">
                    <span class="page_btprev" style="display: none;">&#9664;</span>
                    <span class="page_btnext" style="display: none;">&#9654;</span>
                </div>
            </div>

            <form>
                <div class="search">
                    <input type="text" placeholder="검색어를 입력하세요" class="inputsearch" name="word">
                    <input type="button" value="검색" class="btsearch">
                </div>
            </form>
        </div>
    </section>
    <footer><div class="footer"></div></footer>
</body>
</html>