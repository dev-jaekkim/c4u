<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>admin_review_list</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="./js/hyeongdon.js"></script>   
    <style>
        @import url('https://fonts.googleapis.com/css?family=Raleway&display=swap');
        *{
            box-sizing:border-box;
            padding: 0;
            margin: 0;
            font-family:'Raleway', sans-serif;
            color : #222;
            line-height : 1.5em;
            font-weight:300;
        }

        .admin_review_list .admin_review_title{
            margin-left: 50px;
            margin-top: 30px;
            margin-bottom: 10px;
        }

        .admin_review_list hr{
            opacity: 35%;
            width: 1065px;
            margin-left: 50px;
        }

        .admin_review_list div.review_select_recommendation{
            margin-top: 10px;
            margin-left: 65%;
        }

        .admin_review_list label.chkrecommend{
            margin-right: 10px;
        }

        .admin_review_list span:hover{
            font-weight: 800;
            color: rgb(255, 87, 87);
        }

        .admin_review_list .review_list{
            border: 1px solid;
            border-collapse: collapse;
            margin-left: 50px;
            margin-top: 10px;
        }

        .admin_review_list .review_list th,td{
            border: 1px solid;
        }

        .admin_review_list .review_list th{
            text-align: center;
            background-color: lightgrey;
            font-weight: 800;
        }

        .admin_review_list .review_list td{
            text-align: center;
        }

        .admin_review_list td.review_body_date{
            width: 110px;
        }

        .admin_review_list td.review_body_lessontitle{
            text-align: left;
            padding-left: 10px;
            padding-right: 10px;
            width: 200px;
        }

        .admin_review_list td.review_body_recommend{
            text-align: center;
            width: 60px;
        }

        .admin_review_list td.review_body_content{
            text-align: left;
            width: 500px;
            padding: 3px;
        }

        .admin_review_list td.review_body_writer{
            text-align: center;
            width: 150px;
        }

        .admin_review_list td.review_body_delete{
            width: 50px;
            padding-top: 5px;
            padding-bottom: 5px;
        }

        .admin_review_list td.review_body_delete:hover{
            font-weight: 800;
        }

        .admin_review_list div.page_list{
            margin-left: 35%;
            margin-top: 20px;
        }

        .admin_review_list div.reviewsearch{
            margin-left: 33%;
            margin-top: 10px;
            margin-bottom: 30px;
        }

        .admin_review_list input.reviewbtsearch{
            width: 40px;
            height: 24px;
            vertical-align: -1px;
        }
        
        .admin_review_list input.inputreviewsearch{
            width: 200px;
        }
    </style>
    <script>
        let frontContextPath = "http://localhost:8888/c4ufront";
        let backContextPath = "http://localhost:8888/c4uback";

        $(function(){
            if(adminLoginStatus()==-9){
        		//어드민로그인실패
        		location.href=backContextPath+"/myLogin";
        		return;
        	}//if 어드민 로그인 확인
        	// console.log("front 쿠키 정보 확인");
            $(".header").load("admin_header.html");

            function showList(responseObj){
                console.log(responseObj);
	            //테이블객체
	            var $tableObj =$("section>div.admin_review_list>table.review_list");

                $("section>div.admin_review_list>table.review_list tr.copy").remove();
                console.log("삭제 과정 거침");

                //원본행객체
                var $trOriginObj = $("section>div.admin_review_list>table tr.origin");
                $trOriginObj.show(); //원본행객체 보여주기

                if(responseObj.status == -1){
                    alert(responseObj.msg);
                    return false;
                }else{
                    $(responseObj.pgb.list).each(function(index, element){
                        var $trCopyObj = $trOriginObj.clone(); //원본행객체의 복제본만들기
                        $trCopyObj.addClass("copy"); //복제본행의 클래스속성으로 copy설정
                        $trCopyObj.removeClass("origin"); //복제본행의 클래스속성중 origin제거

                        //복제본행의 내용 채우기 : 날짜
                        $trCopyObj.find("td.review_body_date").html(element.reviewDate);

                        //복제본행의 내용 채우기 : 강좌 제목
                        $trCopyObj.find("td.review_body_lessontitle").html(element.lps.lesson.lessonName);

                        //복제본행의 내용 채우기 : 수강 후기 내용
                        $trCopyObj.find("td.review_body_content").html(element.reviewContent);

                        //복제본행의 내용 채우기 : 추천 여부
                        if(element.recommend == 0){
                            $trCopyObj.find("td.review_body_recommend").html("비추천");
                        }else{
                            $trCopyObj.find("td.review_body_recommend").html("추천");
                        }

                        //복제본행의 내용 채우기 : 작성자
                        $trCopyObj.find("td.review_body_writer").html(element.lps.student.studentName);

                        //복제본행의 내용 채우기 : id
                        $trCopyObj.find("td.review_div_board_no").html(element.reviewId);
                        

                        console.log("reviewID 조회: "+element.reviewId);
                        console.log("reviewId 채울 때 : "+$trCopyObj.find("td.review_div_board_no").html());

                        //테이블객체의 자식객체로 복제본행을 추가
                        $tableObj.append($trCopyObj);
                    }); //each

                    $trOriginObj.hide();
                }
            };//function showList

            function pageGroup(responseObj){
                console.log(responseObj);

                var totalCnt_val = responseObj.pgb.totalCnt;
                var cnt_per_page_val = responseObj.pgb.cnt_per_page;
                var cnt_per_page_group_val = responseObj.pgb.cnt_per_page_group;
                var startPage_val = responseObj.pgb.startPage;
                var endPage_val = responseObj.pgb.endPage;
                var totalPage_val = responseObj.pgb.totalPage;
                var list_size_val = responseObj.pgb.list.length;

                console.log("totalCnt_val :"+totalCnt_val);
                console.log("cnt_per_page_val: "+cnt_per_page_val);
                console.log("cnt_per_page_group_val : "+cnt_per_page_group_val);
                console.log("startPage_val: "+startPage_val);
                console.log("endPage_val : "+ endPage_val);
                console.log("totalPage_val : "+ totalPage_val);
                console.log("list_size_val: "+ list_size_val);
                //divPageList객체
	            var $divPageListObj =$("section>div.admin_review_list>div.page_review_list");

                $("section>div.admin_review_list>div.page_review_list div.copy").remove();
                $("section>div.admin_review_list>div.page_review_list span.copy").remove();

                //원본행객체
                var $pageGroupOriginObj = $("section>div.admin_review_list>div.page_review_list>div.origin");
                $pageGroupOriginObj.show(); //원본행객체 보여주기

                if(responseObj.status == -1){
                    alert(responseObj.msg);
                    return false;
                }else{
                    var $pageGroupCopyObj = $pageGroupOriginObj.clone();  //원본행객체의 복제본만들기
                    $pageGroupCopyObj.addClass("copy"); //복제본행의 클래스속성으로 copy설정
                    $pageGroupCopyObj.removeClass("origin"); //복제본행의 클래스속성중 origin제거

                    var $prevArrowObj = $pageGroupCopyObj.find("span.page_btprev"); //복제행 객체의 이전 화살표 찾기
                    var $nextArrowObj = $pageGroupCopyObj.find("span.page_btnext"); //복제행 객체의 다음 화살표 찾기

                    //이전 화살표 show
                    if(startPage_val > cnt_per_page_group_val){
                        $prevArrowObj.show();
                    }
                    
                    //다음 화살표 show
                    if(endPage_val < totalPage_val){
                        $nextArrowObj.show();
                    }
                    
                    //페이지 넘버 추가
                    for(var i = startPage_val; i<=endPage_val; i++){
                        var $pageNumberObj = $('<span class="page_number, copy">');
                        $pageNumberObj.html("&nbsp;"+"&nbsp;"+"&nbsp;"+i);
                        $nextArrowObj.before($pageNumberObj);
                        $pageNumberObj.show();
                        
                        if(totalCnt_val < cnt_per_page_val){
                            break;
                        }
                    }; //for

                    $divPageListObj.append($pageGroupCopyObj);
                } //else
                $pageGroupOriginObj.hide();

            };//function pageGroup

            $.ajax({
                "url": backContextPath+"/admin/review/list",
                "method": "GET",
                "transformRequest": [
                null
                ],
                "transformResponse": [
                null
                ],
                "jsonpCallbackParam": "callback",
                "headers": {
                "Accept": "application/json, text/plain, */*"
                },
                "data": "",
                "timeout": {},
                success: function(responseObj){
                    showList(responseObj);
                    pageGroup(responseObj);
                }
            }); //$.ajax

            //--검색버튼 클릭 시작--
            $("section>div.admin_review_list>form input[class=btreviewsearch]").click(function(){
                $.ajax({
                        url: backContextPath+"/admin/review/list/1/"+$("section>div.admin_review_list>form input[name=word]").val(),
                        "method": "GET",
                        "transformRequest": [
                            null
                        ],
                        "transformResponse": [
                            null
                        ],
                        "jsonpCallbackParam": "callback",
                        "headers": {
                            "Accept": "application/json, text/plain, */*"
                        },
                        "data": "",
                        "timeout": {},
                        success: function(responseObj){
                            showList(responseObj);
                            pageGroup(responseObj);
                            console.log("검색 버튼이 요청함"+responseObj);
                            // if(responseObj.status = -1){ //Handler 해결 필요
                            //     alert("검색 결과가 없습니다.");
                            //     console.log("상태 확인");
                            // }
                        },
                        error: function(jqXHR){
                            // alert("jqXHR status :"+ jqXHR.status);
                            alert("검색 결과가 없습니다.");
                        }
                });
                return false;
            });
            //--검색버튼 클릭 끝--

            //--페이징 숫자 버튼 클릭 시작--
            $("body>section>div>div.page_review_list").on("click","span",function(event){
                // console.log($(event.target).html());
                console.log("페이지 번호 클릭됨");
                var str_page_number = null;
                if($(event.target).html() == $("span.page_btnext").html()){
                    var bt_next_arrow_val = $(event.target).prev().html();
                    console.log("다음 화살표 값 자르기전: "+bt_next_arrow_val);
                    str_page_number = bt_next_arrow_val.split("&nbsp;&nbsp;&nbsp;");
                    str_page_number[1] = Number(str_page_number[1]) + 1;
                    console.log("다음화살표"+str_page_number[1]);
                }else if($(event.target).html() == $("span.page_btprev").html()){
                    var bt_prev_arrow_val = $(event.target).next().html();
                    console.log("이전 화살표 값 자르기전: "+bt_prev_arrow_val);
                    str_page_number = bt_prev_arrow_val.split("&nbsp;&nbsp;&nbsp;");
                    str_page_number[1] = Number(str_page_number[1]) - 1;
                    console.log("이전화살표"+str_page_number[1]);
                }else{
                    var bt_page_number_val = $(event.target).html().trim();
                    str_page_number = bt_page_number_val.split("&nbsp;&nbsp;&nbsp;");
                    console.log("숫자도 찍힘");
                }
                
                console.log("현재 화살표 값"+str_page_number[1]);
                var word = $("section>div.admin_review_list>form input[name=word]").val();
                var url = backContextPath+"/admin/review/list/"+str_page_number[1];
                if(word.trim() != ''){
                    url += '/' + word;
                }
                
                $.ajax({
                        url: url,
                        "method": "GET",
                        "transformRequest": [
                            null
                        ],
                        "transformResponse": [
                            null
                        ],
                        "jsonpCallbackParam": "callback",
                        "headers": {
                            "Accept": "application/json, text/plain, */*"
                        },
                        "data": "",
                        "timeout": {},
                        success: function(responseObj){
                            showList(responseObj);
                            pageGroup(responseObj);
                        },
                        error: function(jqXHR){
                            // alert("jqXHR status :"+ jqXHR.status);
                            alert("검색 결과가 없습니다.");
                        }
                });//$.ajax
                return false;
            });
            //--페이징 숫자 버튼 클릭 끝--

            //-- 삭제하기 버튼 클릭 시작 --
            $("body>section>div>table>tbody").on("click","td.review_body_delete",function(event){
                console.log("삭제 클릭");
                $("section>div.admin_review_list>table.review_list").hide(); // 수강 후기 테이블 감추기
                $("section>div.admin_review_list>div.page_review_list").hide(); // 페이지 그룹핑 감추기
                $("section>div.admin_review_list>form>div.review_search").hide(); // 검색 그룹핑 감추기
                $("section>div.admin_review_list>div.admin_review_remove").show(); //삭제하기 창띄우기
                
                $("div.admin_review_remove_hidden_reviewId").html($(event.target).next().html());

                return false;
            });
            //--삭제하기 버튼 클릭 끝--

            //--삭제하기 창에서 삭제 클릭 시작--
            var $removeFormObj = $("div.admin_review_remove>form");
            $removeFormObj.submit(function(event){
                
                // var reviewId = $(event.target).next().html();

                var reviewId = $("div.admin_review_remove_hidden_reviewId").html();
                
                 console.log("삭제 reviewId: "+reviewId);
                $.ajax({
                    url: backContextPath +"/admin/review/delete/"+reviewId,
                    "method": "DELETE",
                    "transformRequest": [
                        null
                    ],
                    "transformResponse": [
                        null
                    ],
                    "jsonpCallbackParam": "callback",
                    "headers": {
                        "Accept": "application/json, text/plain, */*"
                    },
                    "timeout": {},
                    success:function(responseObj){
                        if(responseObj.status == 1){
                            $("#adm_review").trigger("click");
                            alert("삭제 성공!");
                        }else{
                            alert(responseObj.msg);
                        }
                    },
                    error:function(jqXHR){
                        // alert("에러:" + jqXHR.status);
                        alert("삭제할 공지사항이 없습니다");
                    }
                });//$.ajax
                return false;
            });
            //--삭제하기 창에서 삭제 클릭 끝--

            //--삭제 하기 창에서 취소 버튼 클릭 시작 --
            $("section>div.admin_review_remove>form>span.btreviewremovecancel").click(function(){
                $("#adm_review").trigger("click");
            });
            //--삭제 하기 창에서 취소 버튼 클릭 끝 --


        });
    </script>
</head>
<body>
    <header><div class="header"></div></header>
    <section>
        <div class="admin_review_list">
            <div class="admin_review_title">
                <h1>수강 후기 관리</h1>
            </div>
            <hr>

            <!--추후구현-->
            <!-- <div class="review_select_recommendation">
                <label class="chkrecommend"><input type="checkbox" name="recommend" value="recommend" checked>추천</label>
                <label class="chknotrecommend"><input type="checkbox" name="recommend" value="notrecommend" checked>비추천</label>
            </div> -->

            <table class="review_list">
                <thead class="review_head">
                    <tr class="review_head_tr">
                        <th>날짜</th>
                        <th>강좌</th>
                        <th>리뷰 내용</th>
                        <th>추천</th>
                        <th>작성자</th>
                        <th>삭제</th>
                    </tr>
                </thead>
                <tbody class="review_body">
                    <tr class="review_body_tr, origin">
                        <td class="review_body_date">2021-05-07</td>
                        <td class="review_body_lessontitle">FRONT 과정</td>
                        <td class="review_body_content">JAVA 재밌어요</td>
                        <td class="review_body_recommend">추천</td>
                        <td class="review_body_writer">ohoh</td>
                        <td class="review_body_delete">삭제</td>
                        <td class="review_div_board_no" style="display: none;"></div>
                    </tr>
                </tbody>
            </table>
            
            <div class="page_review_list">
                <div class="page_group, origin" style="display: none;">
                    <span class="page_btprev" style="display: none;">&#9664;</span>
                    <span class="page_btnext" style="display: none;">&#9654;</span>
                </div>
            </div>
            
            <form>
                <div class="review_search">
                    <input type="hidden" name="review_board_no">
                    <input type="hidden" name="currentPage">
                    <input type="search" name="word" placeholder="검색어를 입력하세요" class="inputreviewsearch" >
                    <input type="button" value="검색" class="btreviewsearch">
                </div>
            </form>

            <div class="admin_review_remove" style="display:none">
                <form>
                    수강후기를 삭제하겠습니까? 
                    <input type="submit" value="삭제">
                    <div class="admin_review_remove_hidden_reviewId" style="display: none;"></div>
                    <span class="btreviewremovecancel">취소</span>
                </form>     
            </div>

        </div>
    </section>
    <footer><div class="footer"></div></footer>
</body>
</html>