<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="mybatis.lpsMapper"> 

<resultMap id="lpsMap" type="com.my.vo.LPS" autoMapping="true">
	<id property= "LPSId" column="lps_id"></id>
	<collection property="student" ofType="com.my.vo.Student" autoMapping="true">
		<id property="studentId" column="lps_student_id"></id>
		<result property="studentName" column="student_name"/>
		<result property="studentEmail" column="student_email"/>
		<result property="studentPhone" column="student_phone"/>
	</collection>
	
	<collection property="lesson" ofType="com.my.vo.Lesson" autoMapping="true">
		<id property="lessonId" column="lesson_id"/>
		<result property="lessonName" column="lesson_name"/>
		<result property="lessonStatus" column="lesson_status"/>
		<result property="lessonFee" column="lesson_fee"/>
		<result property="lessonCategory" column="lesson_category_id"/>
		<result property="lessonEnd" column="lesson_end_date"/>
<!-- 		<result property="lessonStart" column="lesson_start_date "/>
		<result property="lessonTotalFee" column="lesson_total_amount "/> -->
	</collection>

</resultMap>

<select id="selectBylessonId" resultMap="lpsMap">

SELECT student.student_name, student.student_email, student.student_phone
FROM student student JOIN lesson_per_student lps ON(student.student_id = lps.lps_student_id)
JOIN lesson lesson ON (lesson.lesson_id = lps.lps_lesson_id)
WHERE lesson.lesson_id = #{lessonId}
ORDER BY lesson.lesson_id ASC

</select>

<select id="selectByStudentAllLessonCnt" resultType="int">
SELECT COUNT(*) 
FROM student JOIN lesson_per_student ON  student_id = lps_student_id
WHERE student_id = #{studentId}
</select>

<select id="selectByPageStudentLesson" parameterType="java.util.Map"  resultMap="lpsMap">

SELECT * 
		FROM (SELECT lesson_id,lesson_name, lesson_status, lesson_fee, lesson_category_id, lesson_end_date, lesson_start_date lessonStart, lesson_total_amount lessonTotalFee, row_number() OVER (ORDER BY lesson_status ASC, lesson_end_date ASC ,lesson_total_amount DESC) AS rnum  
			  FROM lesson
			  WHERE lesson_id IN(SELECT lps_lesson_id 
				                 FROM lesson_per_student 
				                 WHERE lps_student_id = #{lps_student_id})
				) 
WHERE rnum BETWEEN fun_start_row(#{currentPage},#{cnt_per_page}) AND fun_end_row(#{currentPage},#{cnt_per_page})

</select>


</mapper>